generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/**
 * ======================
 * Enums
 * ======================
 */
enum Role {
  SUPER_ADMIN
  MANAGER
  COORDINATOR
  PUBLIC
  ADMIN
  DRIVER
}

enum BusinessType {
  CARE
  TAXI
}

enum BusinessMembershipRole {
  ADMIN
  COORDINATOR
  MANAGER
  DRIVER
  OWNER
  DISPATCHER
}

enum BidStatus {
  PENDING
  ACCEPTED
  DECLINED
}

enum FeedbackType {
  NOTE
  COMPLAINT
}

enum AdvancedBookingVisibility {
  PRIVATE_TO_COMPANY
  LINK_ONLY
  PUBLIC
}

enum AdvancedBookingStatus {
  OPEN
  CLOSED
  ACCEPTED
  SCHEDULED
  COMPLETED
  CANCELED
}

enum InstantBookingStatus {
  PENDING
  ACCEPTED
  IN_PROGRESS
  COMPLETED
  CANCELED
}

/**
 * ======================
 * Core Models
 * ======================
 */



model PasswordResetToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  user      User     @relation("UserPasswordResetTokens", fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  expiresAt DateTime
}



model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  phone         String?   @unique
  password      String?
  role          Role      @default(PUBLIC)
  image         String?
  emailVerified DateTime?
  isApproved    Boolean   @default(false)
  driverOnboarded      Boolean   @default(false)
  managerOnboarded     Boolean   @default(false)
  coordinatorOnboarded Boolean   @default(false)
  adminOnboarded Boolean @default(false)
  // Self relation: manager â†” drivers
  managerId String?
  manager   User?   @relation("ManagerDrivers", fields: [managerId], references: [id])
  drivers   User[]  @relation("ManagerDrivers")

driver Driver? 
  // Business link
  businessId String?
  business   Business? @relation("UserBusiness", fields: [businessId], references: [id])

  // Area link
  areaId String?
  area   Area?   @relation("UserArea", fields: [areaId], references: [id])

  // Relations
  bids                Bid[]                @relation("UserBids")
  feedback            TripFeedback[]
  invoices            Invoice[]
  memberships         BusinessMembership[] @relation("MembershipUser")
  verifiedMemberships BusinessMembership[] @relation("MembershipVerifier")
  schedules           RideSchedule[]       @relation("DriverSchedules")
  notifications       Notification[]
  incidents           Incident[]
  instantBookings     InstantBooking[]     @relation("CreatorInstantBookings")
  advancedBookings    AdvancedBooking[]    @relation("CreatorAdvancedBookings")

  adminOfBusiness         Business?        @relation("BusinessAdminUser")
  acceptedInstantBookings InstantBooking[] @relation("UserAcceptedInstant")
  passwordResetTokens PasswordResetToken[] @relation("UserPasswordResetTokens")
   passwordResetToken   String?
  passwordResetExpires DateTime?
  // Preferences
  postcode     String?
  radius       Int?
  capabilities String[]

  Account Account[]
  Session Session[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([deletedAt])
}

model Driver {
  id             String   @id @default(cuid())
  userId         String   @unique
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

   // Compliance
  ukDrivingLicence         Boolean @default(false)
  localAuthorityRegistered Boolean @default(false)
  dbsChecked               Boolean @default(false)
  publicLiabilityInsurance Boolean @default(false)
  fullyCompInsurance       Boolean @default(false)
  healthCheckPassed        Boolean @default(false)
  englishProficiency       Boolean @default(false)

 //compliance

  
  vehicleType    String   // e.g. Car, WAV, Minibus
  vehicleReg     String
  localPostcode  String   // base area
  radiusMiles    Int      // pickup radius
  phone          String
  approved       Boolean  @default(false)

  instantBookings  InstantBooking[] @relation("DriverInstantBookings")
  advancedBids     Bid[]            @relation("DriverBids")

 // Vehicle amenities
  amenities String[]

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model Business {
  id       String       @id @default(cuid())
  type     BusinessType
  name     String
  phone    String?
  email    String?
  website  String?
  address1 String?
  city     String?
  postcode String?
  approved Boolean      @default(false)

  // Admin account
  adminUserId String @unique
  adminUser   User   @relation("BusinessAdminUser", fields: [adminUserId], references: [id])

  // Staff & members
  memberships BusinessMembership[] @relation("MembershipBusiness")
  employees   User[]               @relation("UserBusiness")

  // Domain data
  houses                  House[]
  driverInvites           DriverInvite[]
  incidents               Incident[]
  advancedBookings        AdvancedBooking[] @relation("BusinessAdvancedBookings")
  instantBookings         InstantBooking[]  @relation("BusinessInstantBookings")
  acceptedInstantBookings InstantBooking[]  @relation("BusinessAcceptedInstant")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model BusinessMembership {
  id         String                 @id @default(cuid())
  userId     String
  businessId String
  role       BusinessMembershipRole

  user     User     @relation("MembershipUser", fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  business Business @relation("MembershipBusiness", fields: [businessId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  // Verification
  dbsChecked         Boolean @default(false)
  insuranceChecked   Boolean @default(false)
  plInsuranceChecked Boolean @default(false)
  isVerified         Boolean @default(false)

  invitedAt  DateTime?
  verifiedAt DateTime?

  verifiedById String?
  verifiedBy   User?   @relation("MembershipVerifier", fields: [verifiedById], references: [id], onDelete: SetNull, onUpdate: Cascade)

  verifyNotes String?

  createdAt DateTime  @default(now())
  deletedAt DateTime?

  @@unique([userId, businessId])
  @@index([businessId, role])
  @@index([businessId, isVerified])
  @@index([deletedAt])
}

model Area {
  id   String @id @default(cuid())
  name String @unique

  users User[] @relation("UserArea")
}

model House {
  id         String   @id @default(cuid())
  businessId String
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  label    String
  line1    String
  city     String
  postcode String
  notes    String?

  internalId String @unique
  pin        String
  loginName  String @unique

  incidents Incident[]

  createdAt DateTime  @default(now())
  deletedAt DateTime?

  @@index([businessId, label])
  @@index([deletedAt])
}

/**
 * ======================
 * Bookings
 * ======================
 */
model AdvancedBooking {
  id          String @id @default(cuid())
  createdById String
  createdBy   User   @relation("CreatorAdvancedBookings", fields: [createdById], references: [id])

  businessId String?
  business   Business? @relation("BusinessAdvancedBookings", fields: [businessId], references: [id])

  pickupTime      DateTime
  returnTime      DateTime?
  pickupLocation  String
  dropoffLocation String

  // Accessibility
  wheelchairAccess       Boolean @default(false)
  doubleWheelchairAccess Boolean @default(false)
  highRoof               Boolean @default(false)
  carerPresent           Boolean @default(false)
  passengerCount         Int     @default(0)
  wheelchairUsers        Int     @default(0)
  nonWAVvehicle          Boolean @default(false)
  femaleDriverOnly       Boolean @default(false)
  quietEnvironment       Boolean @default(false)
  assistanceRequired     Boolean @default(false)
  noConversation         Boolean @default(false)
  specificMusic          String?
  electricScooterStorage Boolean @default(false)
  visualSchedule         Boolean @default(false)
  assistanceAnimal       Boolean @default(false)
  familiarDriverOnly     Boolean @default(false)
  ageOfPassenger         Int?
  escortRequired         Boolean @default(false)
  preferredLanguage      String?
  signLanguageRequired   Boolean @default(false)
  textOnlyCommunication  Boolean @default(false)
  medicalConditions      String?
  medicationOnBoard      Boolean @default(false)
  additionalNeeds        String?

  // Bidding
  visibility    AdvancedBookingVisibility @default(PRIVATE_TO_COMPANY)
  bidDeadline   DateTime?
  status        AdvancedBookingStatus     @default(OPEN)
  acceptedBidId String?                   @unique
  acceptedBid   Bid?                      @relation("AcceptedBid", fields: [acceptedBidId], references: [id], onDelete: SetNull)

  bids          Bid[]          @relation("AdvancedBookingBids")
  feedback      TripFeedback[]
  invoices      Invoice[]
  notifications Notification[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  schedule RideSchedule?

  @@index([businessId, pickupTime])
  @@index([status, pickupTime])
  @@index([bidDeadline])
  @@index([deletedAt])
}

model InstantBooking {
  id String @id @default(cuid())

  createdById String
  createdBy   User   @relation("CreatorInstantBookings", fields: [createdById], references: [id], onDelete: Cascade)

  businessId String?
  business   Business? @relation("BusinessInstantBookings", fields: [businessId], references: [id], onDelete: Cascade)

  pickupTime      DateTime
  returnTime      DateTime?
  pickupLocation  String
  dropoffLocation String

   driverId String?
  driver   Driver? @relation("DriverInstantBookings", fields: [driverId], references: [id], onDelete: SetNull)

  // Accessibility
  wheelchairAccess       Boolean @default(false)
  doubleWheelchairAccess Boolean @default(false)
  highRoof               Boolean @default(false)
  carerPresent           Boolean @default(false)
  passengerCount         Int     @default(0)
  wheelchairUsers        Int     @default(0)
  nonWAVvehicle          Boolean @default(false)
  femaleDriverOnly       Boolean @default(false)
  quietEnvironment       Boolean @default(false)
  assistanceRequired     Boolean @default(false)
  noConversation         Boolean @default(false)
  specificMusic          String?
  electricScooterStorage Boolean @default(false)
  visualSchedule         Boolean @default(false)
  assistanceAnimal       Boolean @default(false)
  familiarDriverOnly     Boolean @default(false)
  ageOfPassenger         Int?
  escortRequired         Boolean @default(false)
  preferredLanguage      String?
  signLanguageRequired   Boolean @default(false)
  textOnlyCommunication  Boolean @default(false)
  medicalConditions      String?
  medicationOnBoard      Boolean @default(false)
  additionalNeeds        String?

  // Acceptance
  acceptedAt           DateTime?
  acceptedByUserId     String?
  acceptedByUser       User?     @relation("UserAcceptedInstant", fields: [acceptedByUserId], references: [id], onDelete: SetNull)
  acceptedByBusinessId String?
  acceptedByBusiness   Business? @relation("BusinessAcceptedInstant", fields: [acceptedByBusinessId], references: [id], onDelete: SetNull)

  status InstantBookingStatus @default(PENDING)

  feedback      TripFeedback[]
  invoices      Invoice[]
  notifications Notification[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/**
 * ======================
 * Bids / Schedule / Notifications
 * ======================
 */
model Bid {
  id                String          @id @default(cuid())
  advancedBookingId String
  advancedBooking   AdvancedBooking @relation("AdvancedBookingBids", fields: [advancedBookingId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation("UserBids", fields: [userId], references: [id], onDelete: Cascade)

  amountCents  Int
  message      String?
  etaMinutes   Int?
  vehicleNotes String?
  validUntil   DateTime?
  status       BidStatus @default(PENDING)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  driverId String
  driver   Driver @relation("DriverBids", fields: [driverId], references: [id])

  acceptedOnRide AdvancedBooking? @relation("AcceptedBid")
  notifications  Notification[]
  idempotencyKey String?          @unique
  deletedAt      DateTime?

  @@index([advancedBookingId, status, amountCents])
  @@index([userId, createdAt])
  @@index([deletedAt])
}

model RideSchedule {
  id                String          @id @default(cuid())
  advancedBookingId String          @unique
  advancedBooking   AdvancedBooking @relation(fields: [advancedBookingId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  driverId String
  driver   User   @relation("DriverSchedules", fields: [driverId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  startAt DateTime
  endAt   DateTime?
  notes   String?

  createdAt DateTime  @default(now())
  deletedAt DateTime?

  @@index([driverId, startAt])
  @@index([deletedAt])
  @@index([startAt])
}

model Notification {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  type String

  advancedBookingId String?
  advancedBooking   AdvancedBooking? @relation(fields: [advancedBookingId], references: [id], onDelete: SetNull, onUpdate: Cascade)

  instantBookingId String?
  instantBooking   InstantBooking? @relation(fields: [instantBookingId], references: [id], onDelete: SetNull, onUpdate: Cascade)

  bidId String?
  bid   Bid?    @relation(fields: [bidId], references: [id], onDelete: SetNull, onUpdate: Cascade)

  payload Json?
  readAt  DateTime?

  createdAt DateTime  @default(now())
  deletedAt DateTime?

  @@index([userId, createdAt])
  @@index([deletedAt])
}

/**
 * ======================
 * Feedback / Invoices / Invites / Incidents
 * ======================
 */
model TripFeedback {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  advancedBookingId String?
  advancedBooking   AdvancedBooking? @relation(fields: [advancedBookingId], references: [id])
  instantBookingId  String?
  instantBooking    InstantBooking?  @relation(fields: [instantBookingId], references: [id])

  type     FeedbackType @default(NOTE)
  message  String
  resolved Boolean      @default(false)

  createdAt DateTime  @default(now())
  deletedAt DateTime?

  @@index([deletedAt])
  @@index([userId, createdAt])
  @@index([advancedBookingId])
  @@index([instantBookingId])
}

model Invoice {
  id       String @id @default(cuid())
  driverId String
  driver   User   @relation(fields: [driverId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  advancedBookingId String?
  advancedBooking   AdvancedBooking? @relation(fields: [advancedBookingId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  instantBookingId  String?
  instantBooking    InstantBooking?  @relation(fields: [instantBookingId], references: [id], onDelete: SetNull, onUpdate: Cascade)

  amountCents Int
  currency    String    @default("GBP")
  issuedAt    DateTime  @default(now())
  paid        Boolean   @default(false)
  paidAt      DateTime?
  notes       String?
  deletedAt   DateTime?

  @@index([deletedAt])
  @@index([driverId, issuedAt])
  @@index([advancedBookingId])
  @@index([instantBookingId])
}

model DriverInvite {
  id         String   @id @default(cuid())
  businessId String
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  email      String
  token      String    @unique
  expiresAt  DateTime
  acceptedAt DateTime?
  createdAt  DateTime  @default(now())

  @@index([businessId, email])
}

model Incident {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id])
  businessId String
  business   Business @relation(fields: [businessId], references: [id])
  houseId    String?
  house      House?   @relation(fields: [houseId], references: [id])

  time         DateTime
  type         String
  description  String
  emergency    Boolean
  actionsTaken String?
  followUp     Boolean
  image        String?
  evidenceUrl  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/**
 * ======================
 * NextAuth
 * ======================
 */
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model RegisterInterest {
  id        String   @id @default(cuid())
  name      String
  email     String   @unique
  phone     String?
  type      String   // DRIVER | BUSINESS
  message   String?
  approved  Boolean  @default(false)
  createdAt DateTime @default(now())
}
